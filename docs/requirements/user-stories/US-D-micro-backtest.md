# Group D — Micro Backtest 統計

> **群組目標**：提供事件後績效統計與驗證能力  
> **技術範疇**：報酬計算、統計指標、側邊面板顯示  
> **依賴關係**：依賴 Group C（Time Window）

---

## 概述

本群組實現「Micro Backtest」功能，但這**不是完整的交易回測系統**，而是：
- 計算事件發生後特定天數的報酬率
- 彙總多個樣本的績效統計（平均報酬、勝率、最大回撤）
- 以側邊面板即時顯示統計結果
- 提供績效明細表供深入檢視

這是事件研究方法論的核心產出。

---

## User Stories

### US D-1: 事件後報酬計算

**As a** 策略研究員  
**I want** 自動計算每個樣本事件後 N 日的報酬率  
**So that** 我能夠量化事件後的價格變化

#### Acceptance Criteria

**AC1 — 報酬率計算邏輯**
- **Given** 某樣本的事件日收盤價為 P0
- **When** 計算事件後第 N 日報酬
- **Then** 報酬率應為 `(P_N - P0) / P0 * 100%`

**AC2 — 多時間點報酬**
- **Given** 系統設定觀察期為 [+1, +3, +5, +10] 日
- **When** 執行報酬計算
- **Then** 每個樣本應產生 4 個報酬率數值

**AC3 — 資料不足時的處理**
- **Given** 某樣本事件後資料不足 10 日
- **When** 嘗試計算 +10 日報酬
- **Then** 該時間點報酬應標記為 N/A，並在統計時排除

**AC4 — 計算效能**
- **Given** 查詢結果包含 100 個樣本
- **When** 系統計算所有樣本的報酬
- **Then** 計算應在 2 秒內完成

---

### US D-2: 績效指標彙總統計

**As a** 策略研究員  
**I want** 看到所有樣本的彙總績效指標  
**So that** 我能夠評估此策略型態的整體效果

#### Acceptance Criteria

**AC1 — 平均報酬計算**
- **Given** 所有樣本的 +N 日報酬已計算
- **When** 系統產生彙總統計
- **Then** 應計算算術平均報酬率（排除 N/A）

**AC2 — 勝率計算**
- **Given** 所有樣本的報酬已計算
- **When** 計算勝率
- **Then** 勝率應為 `(報酬 > 0 的樣本數) / (總樣本數) * 100%`

**AC3 — 最大回撤計算**
- **Given** 每個樣本從事件日收盤到觀察期結束
- **When** 計算最大回撤
- **Then** 應為 `min((P_t - P0) / P0)` 的最小值（最大負值）

**AC4 — 指標分組顯示**
- **Given** 系統計算了多個觀察期的指標
- **When** 顯示彙總統計
- **Then** 應依時間點分組（如「+1日」、「+3日」各顯示平均報酬/勝率/最大回撤）

---

### US D-3: 側邊績效面板顯示

**As a** 策略研究員  
**I want** 在 Grid 檢視旁看到即時的績效統計面板  
**So that** 我能夠一邊檢視圖表、一邊參考統計數據

#### Acceptance Criteria

**AC1 — 面板位置與佈局**
- **Given** Grid 模式已啟動
- **When** 系統計算完績效統計
- **Then** 應在 Grid 右側顯示一個側邊面板

**AC2 — 面板內容結構**
- **Given** 績效面板已顯示
- **When** 使用者檢視面板
- **Then** 應依序顯示：樣本數量、平均報酬（依時間點）、勝率、最大回撤

**AC3 — 面板即時更新**
- **Given** 使用者變更查詢條件或窗口參數
- **When** Grid 重新載入
- **Then** 績效面板應自動重新計算並更新顯示

**AC4 — 面板可收合**
- **Given** 績效面板已顯示
- **When** 使用者點擊收合按鈕
- **Then** 面板應收合至側邊，Grid 擴展佔滿畫面

---

### US D-4: 績效明細表檢視

**As a** 策略研究員  
**I want** 檢視每個樣本的個別報酬明細  
**So that** 我能夠識別績效異常的樣本並深入分析

#### Acceptance Criteria

**AC1 — 明細表顯示**
- **Given** 使用者在績效面板點擊「檢視明細」
- **When** 明細表開啟
- **Then** 應以表格形式顯示：股票代碼、事件日期、+1日報酬、+3日報酬、+5日報酬、+10日報酬

**AC2 — 明細表排序**
- **Given** 明細表已顯示
- **When** 使用者點擊任一欄位標題
- **Then** 表格應依該欄位遞增或遞減排序

**AC3 — 明細表篩選**
- **Given** 明細表已顯示
- **When** 使用者選擇「只顯示正報酬」或「只顯示負報酬」
- **Then** 表格應即時篩選顯示符合條件的樣本

**AC4 — 點擊樣本定位圖表**
- **Given** 明細表中的樣本也顯示在 Grid 中
- **When** 使用者點擊明細表中的某一列
- **Then** Grid 應自動滾動並高亮該樣本的圖表

---

### US D-5: 績效統計更新機制

**As a** 策略研究員  
**I want** 系統在查詢條件或樣本變更時自動更新統計  
**So that** 我不需要手動重新計算績效

#### Acceptance Criteria

**AC1 — 查詢變更觸發更新**
- **Given** 使用者變更查詢條件（如日期範圍）
- **When** 新的查詢結果載入
- **Then** 績效統計應自動重新計算並更新顯示

**AC2 — 窗口變更觸發更新**
- **Given** 使用者變更時間窗口參數
- **When** Grid 重新渲染
- **Then** 績效統計的觀察期應更新為新的窗口範圍

**AC3 — 部分樣本失敗不影響統計**
- **Given** 部分樣本因資料不足無法計算報酬
- **When** 系統產生統計
- **Then** 應排除失敗樣本，並註明「基於 N/M 個有效樣本」

---

## 技術備註

- **計算邏輯**：後端 FastAPI 計算，避免前端重複運算
- **快取機制**：相同查詢條件的統計結果應快取（參考 Group G）
- **報酬率精度**：保留至小數點後兩位
- **統計指標**：使用 NumPy/Pandas 計算

---

## 依賴關係

- **被依賴於**：Group E（匯出需要統計數據）
- **依賴於**：Group C（需要一致的時間窗口）、Group B（需要樣本清單）
