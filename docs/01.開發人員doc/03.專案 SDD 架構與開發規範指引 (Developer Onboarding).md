這份文件旨在簡要說明本專案 Specification-Driven Development (SDD) 架構的核心規範、層級以及 AI 輔助開發的限制，特別著重於開發過程中的規格調整紀律。

---
# 專案 SDD 架構與開發規範指引 (Developer Onboarding)
## 🎯 一、核心設計理念：唯一真相原則 (Single Source of Truth)
本專案採用 **規格驅動開發 (SDD)** 作為核心方法。
**唯一真相 (Single Source of Truth)** 必須是位於 `specs/system/spec.md` 的 **System Specification**。所有團隊成員、QA 和 AI 均以此文件作為驗證系統行為的唯一來源。
- **規格先行**：開發流程必須依序完成：定義 `spec.md` → 定義 `plan.md` → 定義 `tasks.md` → 實作程式碼。
- **憲法地位**：`constitution.md` 確立了不可協商的治理原則，所有人類與 AI 代理人都必須遵守這些規則。
## 📐 二、架構層級與責任邊界
我們採用「同心層架構」來管理規格與行為：

| 層級        | 檔案位置/類型                           | 責任與定位                                | 狀態/限制                               |
| :-------- | :-------------------------------- | :----------------------------------- | :---------------------------------- |
| **最外層護欄** | `.github/copilot-instructions.md` | **工具層的全域行為限制**，防止 AI 在流程外做出違規操作。     | 🔴 **Guardrail**，非規格來源。             |
| **系統真相**  | `specs/system/`                   | 系統行為的**唯一真相** (System Spec, Design)。 | 🟢 **Live Doc**，唯一修改入口是 Unify Flow。 |
| **變更集合**  | `specs/features/NNN-*/`           | 本次開發的**差異規格** (Feature Spec)。        | 🟡 **開發中**，允許演化，但最終必須整合或封存。         |
| **整合機制**  | `specs/system/unify-flow.md`      | **系統規格的唯一修改入口**，管理 Feature 合併。       | 🔴 **NON-NEGOTIABLE** 流程。           |
| **歷史紀錄**  | `specs/history/`                  | 封存已完成的 Feature Spec / Plan / Tasks。  | 🔴 **唯讀**，不得將其視為現行規格。               |
## 🛡️ 三、AI 與系統規格保護 (System Spec Protection)
保護 System Spec 不被意外修改是本架構的 **CRITICAL** 規則。
1. **System Spec 的唯一修改通道是 Unify Flow**。
2. **非統合流程期間的禁止行為**：**MUST NOT** 在 Feature 開發中直接修改 `specs/system/**` 下的任何文件。憲法條款明確禁止在非統合流程期間修改 specs/system/。
3. **AI 的全域限制**：在 `.github/copilot-instructions.md` (作為 Copilot 的全域護欄) 中，已規定 AI **NEVER** 修改 `specs/system/**`，除非指令中明確指出正在執行 UNIFY FLOW，且清楚指定要修改的檔案與段落。
## 🔄 四、規格調整與例外處理 (重點紀律)
規格調整必須嚴格遵守以下原則，這是確保唯一真相原則的關鍵：
### 4.1 Debug 與 Bug Fix 原則

|問題類型|處理方式|System Spec (specs/system/**)|
|:--|:--|:--|
|**實作 Bug**|程式碼未符合 System Spec 定義的行為。|僅修正程式碼與測試，**不得修改規格**。|
|**規格 Bug** / 遺漏規格|System Spec 定義有誤或不完整。|**必須走 Hotfix Feature 流程**，更新 Feature Spec，最終透過 **Unify Flow** 整合。|
**核心原則**：Debug 期間，若發現問題是規格層面的，**必須先更新 Feature Spec**，再更新程式碼，且所有規格調整最終都必須透過 Unify Flow 整合。Debug 永遠不能成為偷渡 system spec 變更的理由。
### 4.2 Feature 開發中途的規格調整
Feature 開發中途允許調整規格，但必須辨別調整的性質：

|情境|判斷標準|處理方式|
|:--|:--|:--|
|**自然演化**|僅補充或修正原 Feature Spec，沒有新增全新使用者目標。|**直接修改該 Feature 的 spec.md**。|
|**需求擴張**|新增全新的 user goal，或擴張到未規劃的模組。|**停止** 擴寫原 Feature spec，**開一個新的 Feature**。|
**核心限制**：**可以改規格，但不能偷渡新 Feature**。
### 4.3 UI 行為治理
UI（使用者介面）行為被視為「系統外部行為」的一部分，因此必須納入規格治理。
- **同步要求**：UI 行為變更屬於規格變更，**不得僅修改程式碼**。
- **回填機制**：開發中允許 UI 逐步演化，但最終整合前，**MUST 將實際行為回填至 Feature Spec**。
- **整合**：UI 行為最終透過 **Unify Flow** 整合進 `specs/system/spec.md`。純視覺細節則不需記錄於 SDD 規格中。
## 🤝 五、統合流程 (Unify Flow)
`unify-flow.md` 定義了 Feature 規格合併回 main 分支的唯一標準。
**執行時機**：Feature 完成、準備 PR 前。
**核心步驟與原則**：
1. **Feature 識別**：AI 執行 Unify Flow 前，**MUST** 由人類明確指定要處理的 Feature 目錄。
2. **合併原則**：AI **MUST** 以 **System Spec 為基底**，將 Feature Spec 的變更合併至 System Spec。
3. **衝突處理**：若發生衝突，**以 Feature Spec 為準**，因為它代表最新的設計意圖。
4. **保留未涉及部分**：Feature Spec 未提及的 System Spec 內容 **MUST 完整保留**。
5. **同步更新**：AI **MUST** 同步更新 System Design 層的文件（如 `data-model.md`, `contracts/`, `flows.md`）。
6. **檢查**：**MUST** 執行 `/speckit.analyze` 進行一致性檢查，通過後才可合併。
7. **禁止行為**：不得跨過統合流程直接發 PR，且不得讓 Feature Spec 留在 main 分支。
> **總結比喻：** 如果將整個系統規格視為一座城市（System Spec），那麼 **Constitution** 就是這座城市的憲法（決定治理原則），而 **Copilot Instructions** 就像在城外加設的無人機行為管制區（確保工具不會亂飛）。當我們開發新功能時，我們在郊區的實驗室（Feature Spec）進行設計，只有當設計經過嚴格的 **Unify Flow** 檢查和批准後，才能將變更納入這座城市的核心地圖（System Spec）中。