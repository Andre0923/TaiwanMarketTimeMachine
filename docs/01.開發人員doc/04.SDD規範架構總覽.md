# SDD 規範架構總覽

> **文件性質**：開發團隊入門指南  
> **適用對象**：所有參與專案的開發人員  
> **版本**：1.0.0  
> **最後更新**：2025-12-16

---

## 目錄

1. [整體架構概觀](#一整體架構概觀)
2. [文件層級與目錄結構](#二文件層級與目錄結構)
3. [規範文件的作用範圍](#三規範文件的作用範圍)
4. [核心流程：Spec Kit + Unify Flow](#四核心流程spec-kit--unify-flow)
5. [開發情境指南](#五開發情境指南)
6. [常見問題 FAQ](#六常見問題-faq)

---

## 一、整體架構概觀

本專案採用 **Specification-Driven Development（SDD）** 方法論，搭配 **Spec Kit** 工具與 **Unify Flow** 流程，確保規格、設計、程式碼三者始終一致。

### 1.1 架構全景圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           規範層級架構                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  .github/copilot-instructions.md                                │   │
│  │  ────────────────────────────────────────                       │   │
│  │  作用：限制 GitHub Copilot (Agent Mode) 的全域行為               │   │
│  │  範圍：所有 Copilot 對話（不限於 Spec Kit 指令）                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              ▲                                          │
│                              │ 互補                                     │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  .specify/memory/constitution.md                                │   │
│  │  ────────────────────────────────────────                       │   │
│  │  作用：Spec Kit 工作流的完整憲法                                  │   │
│  │  範圍：/speckit.* 指令執行時載入                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              ▲                                          │
│                              │ 定義                                     │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  specs/system/unify-flow.md                                     │   │
│  │  ────────────────────────────────────────                       │   │
│  │  作用：Feature → System 統合流程的 SOP                          │   │
│  │  範圍：Feature 開發完成、PR 前必須執行                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 三層規範的關係

| 層級 | 文件 | 約束對象 | 何時生效 |
|------|------|----------|----------|
| **全域層** | `.github/copilot-instructions.md` | GitHub Copilot (所有模式) | 每次 Copilot 對話 |
| **SDD 層** | `.specify/memory/constitution.md` | Spec Kit 工作流 | 執行 `/speckit.*` 指令時 |
| **流程層** | `specs/system/unify-flow.md` | Unify Flow 操作 | Feature → System 統合時 |

**關鍵理解**：
- 全域層是「最外層防線」，確保 Copilot 在任何情況下都遵守基本規範
- SDD 層是「方法論核心」，定義完整的開發治理準則
- 流程層是「操作 SOP」，確保規格統合的標準化執行

---

## 二、文件層級與目錄結構

### 2.1 目錄結構總覽

```
project-root/
├── .github/
│   └── copilot-instructions.md    # 🔵 Copilot 全域指令（限制 AI 行為）
│
├── .specify/                       # 🟣 Spec Kit 內部資料
│   ├── memory/
│   │   └── constitution.md        # 🔴 SDD 憲法（唯一治理準則）
│   └── guidelines/                # 🟡 輔助指引（非憲法層級）
│
├── specs/                          # 🔴 SDD 中心
│   ├── system/                    # 🟥 System 層（唯一真相）
│   │   ├── spec.md               # 系統行為規格
│   │   ├── data-model.md         # 資料模型設計
│   │   ├── flows.md              # 流程圖/狀態流轉
│   │   ├── unify-flow.md         # 統合流程 SOP
│   │   └── contracts/            # 介面契約
│   │
│   ├── features/                  # 🟡 Feature 層（開發中）
│   │   └── NNN-feature-name/
│   │       ├── spec.md           # Feature Spec（差異規格）
│   │       ├── plan.md           # Feature Plan
│   │       └── tasks.md          # Feature Tasks
│   │
│   └── history/                   # 🟤 History 層（已封存）
│       ├── specs/
│       ├── plans/
│       └── tasks/
│
├── docs/                           # 🟢 開發規劃文件
│   ├── PRD.md                     # 產品需求（規劃輸入）
│   ├── Full-User-Story-List.md   # 完整 User Story（規劃輸入）
│   └── 01.開發人員doc/            # 開發指南
│
├── src/                            # 程式碼
├── tests/                          # 測試
└── logs/                           # 日誌
```

### 2.2 各層級說明

| 層級 | 位置 | 用途 | 狀態 |
|------|------|------|------|
| **System** | `specs/system/` | 唯一真相：整體系統行為與設計 | 🟢 Live Doc |
| **Feature** | `specs/features/NNN-*/` | 差異規格：本次開發的變更 | 🟡 開發中 |
| **History** | `specs/history/` | 封存：已合併的歷史版本 | 🔴 唯讀 |
| **Docs** | `docs/` | 開發規劃輸入文件 | 🟢 參考用 |

### 2.3 重要限制

> ⚠️ `docs/` 目錄下的文件（如 `Full-User-Story-List.md`、`Phase-X.md`）  
> **僅供開發規劃參考，不得在 Unify Flow 中作為合併來源，也不能取代 System Spec。**

---

## 三、規範文件的作用範圍

### 3.1 `.github/copilot-instructions.md` — 全域 AI 行為限制

**作用範圍**：所有 GitHub Copilot 對話（包含 Agent Mode、Chat、Inline Suggestions）

**核心規範**：
- 回覆使用繁體中文
- 不確定先問人類（ASK before assume）
- **NEVER 修改 `specs/system/**`**（除非明確執行 Unify Flow）
- Debug 時不得動 System Spec
- 修改前提供 PLAN，修改後說明 CHECKS

**為什麼需要這層？**

Spec Kit 的 constitution 只在執行 `/speckit.*` 指令時載入。如果開發者直接用 Copilot Agent Mode 做事，不走 Spec Kit 流程，AI 就不會受 constitution 約束。

`.github/copilot-instructions.md` 確保**無論走不走 Spec Kit，AI 都會遵守最基本的護欄**。

---

### 3.2 `.specify/memory/constitution.md` — SDD 完整憲法

**作用範圍**：Spec Kit 工作流（`/speckit.specify`、`/speckit.analyze` 等指令）

**核心規範**：
- SDD 文件層級架構（System / Feature / History）
- User Story 撰寫標準（BDD 格式）
- 核心原則（Test-First、AI Transparency、Security by Default）
- 一致性檢查規則
- AI Agent 使用規範
- Unify Flow 治理條款

**為什麼憲法這麼長？**

因為它是「方法論的完整定義」，涵蓋：
- **WHAT**（Spec 層）：描述系統做什麼
- **HOW-持續**（Design 層）：描述系統怎麼做（跨版本）
- **HOW-本次**（Plan 層）：描述這次版本怎麼做
- **執行**（Tasks 層）：描述可驗收的任務

---

### 3.3 `specs/system/unify-flow.md` — 統合流程 SOP

**作用範圍**：Feature 開發完成，準備合併至 main 之前

**核心流程**：
1. 解析 Feature Spec（抽取差異）
2. 合併至 System Spec（衝突以 Feature 為準）
3. 更新 System Design（data-model / contracts / flows）
4. 封存 Feature 至 History
5. 執行 `/speckit.analyze` 通過
6. 發 PR 合併

**版本合併原則 🔴 CRITICAL**：
- **System Spec 是基底**，Feature Spec 是更新來源
- **衝突以 Feature Spec 為準**（代表最新設計意圖）
- **保留未涉及部分**：Feature 未提及的內容必須完整保留
- **僅處理指定 Feature**：AI 不得自行決定要合併哪個 Feature

---

## 四、核心流程：Spec Kit + Unify Flow

### 4.1 完整開發流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        SDD 開發生命週期                              │
└─────────────────────────────────────────────────────────────────────┘

1. 規劃階段
   ┌─────────────────┐
   │ 需求 / PRD      │
   │ User Story 清單  │ ──→ 參考用，不是唯一真相
   └─────────────────┘
           │
           ▼
2. Feature 定義
   ┌─────────────────────────────────────────┐
   │ /speckit.specify                        │
   │ 建立 specs/features/NNN-xxx/spec.md     │
   │ 建立 plan.md / tasks.md                 │
   └─────────────────────────────────────────┘
           │
           ▼
3. 開發階段
   ┌─────────────────────────────────────────┐
   │ 寫測試 → 寫程式碼 → Debug               │
   │                                         │
   │ ⚠️ 期間可修改 Feature Spec              │
   │ ❌ 不得修改 System Spec                 │
   └─────────────────────────────────────────┘
           │
           ▼
4. 統合階段
   ┌─────────────────────────────────────────┐
   │ Unify Flow                              │
   │ Feature Spec → System Spec              │
   │ 更新 Design / 封存 History               │
   │ /speckit.analyze 通過                   │
   └─────────────────────────────────────────┘
           │
           ▼
5. 合併階段
   ┌─────────────────────────────────────────┐
   │ PR Review → Merge to main               │
   │ main 分支只有 System Spec（唯一真相）    │
   └─────────────────────────────────────────┘
```

### 4.2 Spec Kit 常用指令

| 指令 | 用途 |
|------|------|
| `/speckit.specify` | 建立 Feature Spec |
| `/speckit.plan` | 建立 Feature Plan |
| `/speckit.tasks` | 建立 Feature Tasks |
| `/speckit.analyze` | 一致性檢查 |
| `/speckit.implement` | 依規格實作 |

### 4.3 Unify Flow 觸發時機

**何時執行？**
- Feature 開發完成
- 準備發 PR 合併至 main 之前

**如何呼叫？**
```
請執行 Unify Flow，將 specs/features/NNN-feature-name/ 統合至 System Spec
```

---

## 五、開發情境指南

### 5.1 正常 Feature 開發

```
1. 建立 feature 分支
2. /speckit.specify 定義 Feature Spec
3. /speckit.plan 建立計畫
4. /speckit.tasks 建立任務
5. 寫測試 → 寫程式碼
6. 執行 Unify Flow
7. 發 PR
```

### 5.2 Debug 時發現規格問題

| 問題類型 | 處理方式 |
|----------|----------|
| **實作偏離規格** | 修正程式碼，**不改規格** |
| **規格不足** | 先更新 **Feature Spec**，再改程式碼 |
| **規格錯誤** | 先更新 **Feature Spec**，再改程式碼 |

> 🔴 **禁止**：Debug 時直接修改 `specs/system/`

### 5.3 開發中途改規格

| 情境 | 處理方式 |
|------|----------|
| **同一 Feature 自然演化** | 直接修改該 Feature 的 spec.md |
| **需求擴張（新 user goal）** | 開一個新的 Feature 目錄 |

**判斷標準**：
- ✅ 原本 spec 已有描述，只是補充或修正 → 同一 Feature
- ⚠️ 新增全新使用情境 → 新 Feature
- ⚠️ 影響到其他 Feature 或系統邊界 → 新 Feature

### 5.4 main 分支 Bug 修復

| Bug 類型 | 分支命名 | 需要 Unify Flow？ |
|----------|----------|-------------------|
| **實作 Bug**（程式碼有誤） | `fix/NNN-xxx` | ❌ 不需要 |
| **規格 Bug**（Spec 有誤） | `hotfix/NNN-xxx` | ✅ 需要 |

---

## 六、常見問題 FAQ

### Q1：為什麼有 constitution 還要有 copilot-instructions？

**答**：作用範圍不同。

- `constitution.md`：只在執行 `/speckit.*` 指令時載入
- `copilot-instructions.md`：所有 Copilot 對話都會載入

如果開發者用 Copilot Agent Mode 直接做事（不走 Spec Kit），只有 `copilot-instructions.md` 能限制 AI。

---

### Q2：AI 會不會不小心改到 System Spec？

**答**：有可能，所以我們有三道防線：

1. **規範層**：copilot-instructions 明確寫 `NEVER 修改 specs/system/**`
2. **流程層**：只有 Unify Flow 才能改 System Spec
3. **工程層**（建議）：用 CI/CODEOWNERS 保護 `specs/system/`

---

### Q3：docs/ 目錄的文件可以用嗎？

**答**：可以**參考**，但不能當作唯一真相。

| 可以 | 不可以 |
|------|--------|
| 參考 User Story 清單規劃開發順序 | 在 Unify Flow 中作為合併來源 |
| 查看 Phase 內容了解需求 | 從 docs/ 推導現行系統行為 |

---

### Q4：Feature Spec 和 System Spec 衝突時以誰為準？

**答**：**以 Feature Spec 為準**。

因為 Feature Spec 代表「本次開發的最新設計意圖」。這是 Unify Flow 的核心合併原則。

---

### Q5：什麼時候可以不走 Unify Flow？

**答**：只有「實作 Bug 修復」可以不走。

| 情境 | 需要 Unify Flow |
|------|-----------------|
| Feature 開發完成 | ✅ |
| 規格 Bug 修復 | ✅ |
| 實作 Bug 修復（程式碼錯誤） | ❌ |

---

## 附錄：關鍵文件快速索引

| 文件 | 位置 | 用途 |
|------|------|------|
| Copilot 全域指令 | `.github/copilot-instructions.md` | 限制 AI 行為 |
| SDD 憲法 | `.specify/memory/constitution.md` | 完整治理準則 |
| Unify Flow SOP | `specs/system/unify-flow.md` | 統合流程操作 |
| System Spec | `specs/system/spec.md` | 系統行為唯一真相 |
| 規格調整指南 | `docs/01.開發人員doc/03.規格調整與Bug修復指南.md` | 例外情境處理 |
| 本文件 | `docs/01.開發人員doc/04.SDD規範架構總覽.md` | 入門理解 |

---

**Changelog**:
- v1.0.0 (2025-12-16): 初版建立，整合 constitution、copilot-instructions、unify-flow 三層規範說明
