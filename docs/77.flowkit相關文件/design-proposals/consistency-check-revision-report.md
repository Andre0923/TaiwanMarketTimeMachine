# 一致性檢查架構修正報告

> **報告日期**：2026-01-23  
> **報告類型**：概念修正 + 架構重新設計  
> **狀態**：已完成

---

## 1. 問題識別

### 1.1 原始問題

在設計一致性檢查架構時，存在一個**根本性的概念錯誤**：

| 面向 | 錯誤認知 | 正確認知 |
|------|----------|----------|
| **Feature Spec 的角色** | 應該與 System Spec 一致 | Feature Spec 是「更新來源」，本來就會不同 |
| **檢查目標** | 檢查 Feature vs System 的「差異」 | 檢查「非意圖性錯誤」（疏忽、手誤等） |
| **差異的定位** | 差異是問題 | 差異是意圖，不是問題 |

### 1.2 問題影響

原始設計會導致：

1. **檢查方向錯誤**：將「Feature 要修改 System」視為不一致
2. **誤報率高**：所有意圖內的變更都會被標記為問題
3. **工具無法使用**：開發者會因大量誤報而放棄使用

---

## 2. 修正內容

### 2.1 概念修正

```
❌ 舊概念：一致性檢查 = 檢查 Feature ≠ System 的差異
✅ 新概念：一致性檢查 = 檢查「非意圖性錯誤」
```

**非意圖性錯誤的定義**：

| 類型 | 說明 | 範例 |
|------|------|------|
| 重複實作 | 規劃已存在的功能 | Plan 設計了 System 已有的 Logger |
| 遺漏複用 | 應該複用但未複用 | 未使用 project-context.md 列出的共享服務 |
| 非意圖變動 | 涉及未聲明的變更 | 修改了 Spec 未提及的檔案 |
| 細節誤用 | 編號/引用/命名錯誤 | 引用的 UI ID 不存在 |
| Spec 品質不足 | 結構不完整 | 缺少必要的 AC 定義 |

### 2.2 架構重新設計

#### 從三層防護改為兩階段檢查

| 原設計 | 新設計 |
|--------|--------|
| Layer 1: Plan 內嵌警告 | 合併至 Stage 1 |
| Layer 2: Feature-System 差異檢查 | ❌ 移除（錯誤方向） |
| Layer 3: Unify Flow Phase 5 | 保留（精簡化） |
| - | ✅ Stage 1: `/flowkit.consistency-check` |
| - | ✅ Stage 2: `/flowkit.pre-unify-check` |

#### 新的兩階段設計

```
Stage 1: Plan 階段後（/flowkit.consistency-check）
├─ 時機：/speckit.plan 完成後
├─ 目標：Shift-Left，早期攔截非意圖錯誤
└─ 檢查：重複、複用、範圍、細節

Stage 2: Unify 前（/flowkit.pre-unify-check）
├─ 時機：實作完成後
├─ 目標：品質守門 + 最終攔截
└─ 檢查：Spec 品質、實作對齊、最後防線
```

---

## 3. 檔案變更清單

### 3.1 新建檔案

| 檔案 | 用途 |
|------|------|
| `flowkit.consistency-check.agent.md` | Stage 1：Plan 階段後的非意圖性錯誤檢查工具 |

### 3.2 重新設計檔案

| 檔案 | 變更說明 |
|------|----------|
| `flowkit.pre-unify-check.agent.md` | 從「Feature-System 差異檢查」改為「Spec 品質 + 最終攔截」 |

### 3.3 更新檔案

| 檔案 | 變更說明 |
|------|----------|
| `consistency-check-architecture.md` | 修正概念、從三層改為兩階段、更新流程圖 |
| `flowkit.unify-flow.prompt.md` | Phase 5 精簡化（之前已完成） |

### 3.4 備份檔案

| 檔案 | 說明 |
|------|------|
| `flowkit.pre-unify-check.agent.md.bak` | 舊版本備份 |

---

## 4. 新工具規格摘要

### 4.1 /flowkit.consistency-check

**定位**：Plan 階段後的非意圖性錯誤檢查

**檢查項目**：

| 類別 | 項目 | 嚴重性 |
|------|------|--------|
| A. 重複實作 | 功能重複、模組重複 | HIGH/MEDIUM |
| B. 複用遺漏 | 共享服務未使用、工具函數重寫 | HIGH/MEDIUM |
| C. 非意圖變動 | 範圍溢出、隱性依賴 | HIGH/MEDIUM |
| D. 細節誤用 | ID 引用錯誤、命名不一致 | HIGH/MEDIUM |
| E. 整合建議 | 更好的模組位置 | SUGGESTION |

**全新功能處理**：
- A 類：部分適用
- B1：仍適用
- C 類：N/A
- D、E：仍適用

### 4.2 /flowkit.pre-unify-check

**定位**：Unify 前的 Spec 品質驗證與最終攔截

**檢查項目**：

| 類別 | 項目 |
|------|------|
| Spec 品質 | 結構完整性、格式正確性、內容品質 |
| 引用正確性 | ID 引用存在、命名一致性 |
| Spec-實作對齊 | AC 有對應實作、實作產物存在、變更範圍一致 |
| 最終攔截 | consistency-check 問題追蹤、HIGH 項目最終掃描 |

**輸出**：Unify 準備狀態（READY / READY_WITH_WARNINGS / NOT_READY）

**全新功能處理**：
- Spec 品質：完整適用
- 引用正確性：新 ID 標記為「新增項目」
- 實作對齊中的 T1-T3：N/A
- 最終攔截：完整適用

---

## 5. 關鍵設計決策

### 5.1 保留獨立工具（不合併到 /speckit.analyze）

**理由**：
- `/speckit.analyze` 是 Feature 內部一致性檢查
- 新工具是「非意圖性錯誤」檢查，職責不同
- 觸發時機不同（Plan 後 vs Tasks 後）

### 5.2 兩階段而非單一工具

**理由**：
- Stage 1 要 Shift-Left（早期發現）
- Stage 2 要 Quality Gate（合併前守門）
- 檢查重點不同，分開更清晰

### 5.3 條件式檢查（全新功能 N/A）

**理由**：
- 全新功能不存在「複用檢查」的基準
- 避免無意義的 N/A 項目干擾報告
- 保持報告的有效性

---

## 6. 完整開發流程（更新後）

```
┌────────────────────────────────────────────────────────────────┐
│  /speckit.specify → /speckit.plan                              │
└────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────────────┐
│  /flowkit.consistency-check ← Stage 1：非意圖性錯誤檢查        │
│  檢查：重複 │ 複用 │ 範圍 │ 細節                                │
└────────────────────────────────────────────────────────────────┘
                          │
                    PASS? ─No→ 修正 Plan
                          │
                         Yes
                          │
                          ▼
┌────────────────────────────────────────────────────────────────┐
│  /speckit.tasks → /speckit.implement → 測試                    │
└────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────────────┐
│  /flowkit.pre-unify-check ← Stage 2：Spec 品質 + 最終攔截      │
│  檢查：品質 │ 引用 │ 對齊 │ 最後防線                            │
└────────────────────────────────────────────────────────────────┘
                          │
                    PASS? ─No→ 修正問題
                          │
                         Yes
                          │
                          ▼
┌────────────────────────────────────────────────────────────────┐
│  /flowkit.unify-flow                                           │
│  Phase 5：合併操作驗證（精簡版）                                │
└────────────────────────────────────────────────────────────────┘
                          │
                          ▼
                     PR & Merge
```

---

## 7. 驗證清單

### 7.1 檔案存在性 ✅

- [x] `flowkit.consistency-check.agent.md` 已建立
- [x] `flowkit.pre-unify-check.agent.md` 已重新設計
- [x] `consistency-check-architecture.md` 已更新
- [x] `flowkit.pre-unify-check.agent.md.bak` 已備份

### 7.2 概念一致性 ✅

- [x] 所有文件使用「非意圖性錯誤」而非「Feature-System 差異」
- [x] 兩階段分工明確（Stage 1: Shift-Left, Stage 2: Quality Gate）
- [x] 全新功能的 N/A 處理已設計

### 7.3 流程整合 ✅

- [x] Stage 1 在 Plan 後、Tasks 前
- [x] Stage 2 在 Implement 後、Unify 前
- [x] Unify Flow Phase 5 已精簡

---

## 8. 後續建議

### 8.1 短期（可選）

- [ ] 在 `/speckit.plan` 中加入對 project-context.md 的更強整合
- [ ] 設計 consistency-check 報告的持久化機制

### 8.2 中期（視需求）

- [ ] 建立 consistency-check 的檢查項目配置機制
- [ ] 允許專案自訂檢查規則

---

> **報告結束**  
> 本修正已解決原始概念錯誤，建立正確的「非意圖性錯誤檢查」架構。
