# 規格調整與 Bug 修復指南

> **文件性質**：例外情境處理的詳細說明  
> **適用對象**：開發團隊成員  
> **版本**：1.0.0  
> **最後更新**：2025-12-16

---

## 目錄

1. [Debug 與規格更新原則](#一debug-與規格更新原則)
2. [Feature 中途改規格](#二feature-中途改規格)
3. [main 分支 Bug 修復](#三main-分支-bug-修復)
4. [UI 行為與規格同步](#四ui-行為與規格同步)

---

## 一、Debug 與規格更新原則

在 Feature 分支開發過程中，debug 與實作修正必須遵守以下原則。

### 1.1 問題分類與處理

```
發現問題 → 判斷類型 → 對應處理
```

| 問題類型 | 說明 | 處理方式 |
|----------|------|----------|
| **實作偏離規格** | 程式碼/測試未符合既有 Spec | 僅修正程式碼，**不改規格** |
| **規格不足** | Spec 描述不完整 | **先更新 Feature Spec**，再改程式碼 |
| **規格錯誤** | Spec 定義有誤 | **先更新 Feature Spec**，再改程式碼 |

### 1.2 處理流程

**情境 A：實作偏離規格**
```
1. 確認 Spec 定義正確
2. 修正測試（若需要）
3. 修正程式碼
4. 驗證通過
```

**情境 B：規格不足或錯誤**
```
1. 更新 specs/features/NNN-xxx/spec.md
2. 更新 plan.md（若需要）
3. 更新測試
4. 更新程式碼
5. 最終在 Unify Flow 整合至 System
```

### 1.3 重要限制

> 🔴 **MUST NOT**：在 Feature 開發中直接修改 `specs/system/` 下任何文件

| 可以修改 | 不可修改 |
|----------|----------|
| `specs/features/NNN-xxx/spec.md` | `specs/system/spec.md` |
| `specs/features/NNN-xxx/plan.md` | `specs/system/data-model.md` |
| 程式碼、測試 | `specs/system/flows.md` |

**唯一例外**：正在執行 Unify Flow 時

---

## 二、Feature 中途改規格

### 2.1 核心原則

> 🔑 **Feature 開發中途可以改規格，但不能偷渡新 Feature**

改 spec 很正常，改 scope 才需要停下來重新定義。

### 2.2 判斷流程

```
想改規格 → 判斷範圍 → 選擇處理方式
```

### 2.3 情境 A：同一 Feature 的自然演化

**符合條件**：
- ✅ 原本 spec 已有描述，只是需要補充或修正
- ✅ 沒有新增全新使用情境
- ✅ 不影響其他 Feature 或系統邊界

**處理方式**：
1. 直接修改該 Feature 的 `spec.md`
2. 視需要更新 `plan.md`
3. 更新測試 → 更新程式碼
4. 最終在 Unify Flow 併入 System

**範例**：
- 發現某個 AC 缺少邊界條件 → 補充 AC
- 發現錯誤訊息描述不夠清楚 → 修正文案
- 發現需要額外一個驗證步驟 → 補充至現有 User Story

---

### 2.4 情境 B：需求擴張

**符合條件**（任一即是）：
- ⚠️ 新增全新的 user goal
- ⚠️ 擴張到原本未規劃的模組
- ⚠️ 影響到其他 Feature 或系統假設

**處理方式**：
1. **停止**擴寫原 Feature spec
2. **開一個新的 Feature 目錄**
3. 用 `/speckit.specify` 重新定義新 Feature
4. 原 Feature 照原計畫完成或縮減 scope

**範例**：
- 開發「上傳檔案」時，想加入「批次上傳」功能 → 開新 Feature
- 開發「查詢報表」時，想加入「匯出 PDF」功能 → 開新 Feature
- 發現需要修改資料模型影響其他功能 → 評估是否開新 Feature

---

## 三、main 分支 Bug 修復

> 當已合併至 main 的功能發現 bug 時，依以下流程處理

### 3.1 Bug 類型判斷

| 類型 | 說明 | 判斷依據 |
|------|------|----------|
| **實作 Bug** | 程式碼未符合 System Spec | Spec 定義正確，程式碼有誤 |
| **規格 Bug** | System Spec 定義有誤 | Spec 本身需要修正 |
| **遺漏規格** | System Spec 缺少定義 | 行為未被 Spec 涵蓋 |

### 3.2 實作 Bug 修復（不改規格）

**流程**：
```bash
# 1. 從 main 建立修復分支
git switch main && git pull
git switch -c fix/NNN-bug-description

# 2. 修復程式碼與測試
#   （不需要建立 Feature 目錄）

# 3. 提交並發 PR
git add .
git commit -m "fix: 修復 XXX 問題"
git push origin fix/NNN-bug-description
```

**特點**：
- 分支命名：`fix/NNN-xxx`
- 不需要 Feature 目錄
- 不需要 Unify Flow
- 直接修程式碼、發 PR

---

### 3.3 規格 Bug / 遺漏規格修復

**流程**：
```bash
# 1. 從 main 建立 Hotfix Feature 分支
git switch main && git pull
git switch -c hotfix/NNN-spec-fix

# 2. 建立 Feature 目錄
mkdir -p specs/features/NNN-hotfix-description

# 3. 撰寫 Feature Spec（描述規格修正）
# 4. 修復程式碼與測試
# 5. 執行 Unify Flow
# 6. 發 PR 合併至 main
```

**特點**：
- 分支命名：`hotfix/NNN-xxx`
- 需要 Feature 目錄
- 需要完整 Unify Flow
- Spec 修正透過正規流程整合

---

### 3.4 Hotfix Feature Spec 範例

```markdown
# Feature Spec: NNN-hotfix-description

## 變更摘要
修正 System Spec 中 XXX 行為的定義錯誤

## 變更內容

### 修正前
**AC: 檔案格式驗證**
- Given 使用者上傳檔案
- When 檔案格式不支援
- Then 顯示錯誤訊息

### 修正後
**AC: 檔案格式驗證**
- Given 使用者上傳檔案
- When 檔案格式不支援
- Then 顯示錯誤訊息，**並列出支援的格式清單**

### 修正原因
原 AC 未明確要求顯示支援格式清單，導致使用者體驗不佳

## 影響範圍
- 相關 User Story: US-SYS-1
- 相關程式碼: src/upload.py
```

---

## 四、UI 行為與規格同步

### 4.1 核心原則

> UI 行為變更 = 規格變更

UI 不是「視覺調整」就可以隨意改，任何使用者可感知的行為變更都需要更新規格。

### 4.2 開發中的 UI 演化

**允許**：
- UI 行為在開發過程中逐步演化
- 邊實作邊調整互動細節

**要求**：
- 最終整合前，**MUST** 將實際行為回填至 Feature Spec
- 不得僅改程式碼，不更新規格

### 4.3 Debug 過程中的 UI 調整

**發現 UI 行為需調整時**：
1. 修改 Feature Spec（**非** System Spec）
2. 更新測試
3. 修改程式碼
4. 最終透過 Unify Flow 整合

### 4.4 Unify Flow 的 UI 處理

| 內容 | 整合目標 |
|------|----------|
| UI 行為 | `specs/system/spec.md` |
| UI 結構 | System Design（如有） |
| 舊版本 | `specs/history/` |

---

## 快速參考表

| 情境 | 改 Feature Spec? | 改 System Spec? | 需要 Unify Flow? |
|------|------------------|-----------------|------------------|
| Debug：實作偏離規格 | ❌ | ❌ | ❌ |
| Debug：規格不足 | ✅ | ❌ | ✅（最終） |
| Feature 中途：自然演化 | ✅ | ❌ | ✅（最終） |
| Feature 中途：需求擴張 | 開新 Feature | ❌ | ✅（最終） |
| main Bug：實作 Bug | ❌ | ❌ | ❌ |
| main Bug：規格 Bug | ✅（Hotfix） | ❌ | ✅ |

---

**Changelog**:
- v1.0.0 (2025-12-16): 初版建立，整合自 SDD 開發流程指南
