# FlowKit Consistency Check

> **用途**：在 Plan 階段完成後，檢查 Feature Plan 與現有系統的非意圖性衝突  
> **觸發時機**：`/speckit.plan` 完成後、`/speckit.tasks` 執行前  
> **套件**：FlowKit  
> **版本**：1.0.0

---

## 使用者輸入

```text
$ARGUMENTS
```

在繼續執行之前，您**必須（MUST）**考慮使用者輸入（若非空白）。

---

## 目標

在 Feature Plan 產出後，**儘早發現非意圖性錯誤**，避免錯誤延續到 Tasks 和 Implement 階段。

**核心價值**：Shift-Left 問題發現，在規劃階段攔截疏忽，降低後續修正成本。

### 檢查重點

本工具**不檢查**「Feature 與 System 的差異」（那是意圖），而是檢查：

| 類別 | 說明 |
|------|------|
| **重複實作** | Plan 中規劃的功能，System 或程式碼已存在類似實作 |
| **遺漏複用** | 應該引用/複用的模組未引用，而是重新設計 |
| **非意圖變動** | Plan 涉及了 Feature Spec 未聲明要變更的區域 |
| **整合建議** | 與現有架構有更好的整合方式 |
| **細節誤用** | 編號引用錯誤、命名不一致、格式問題 |

---

## 操作限制

### 核心原則

**STRICTLY READ-ONLY**：本指令不修改任何檔案，僅輸出分析報告。

**意圖優先**：Feature Spec 聲明的變更是「意圖」，不在檢查範圍內。

### AI MUST

- 區分「意圖內變更」與「非意圖性錯誤」
- 以 system-context.md 和 System Spec 為比對基準
- 優先檢查 Plan 中的架構決策和模組選擇
- 為每個發現標記「確定問題」或「待確認」
- **遵循 Progressive Disclosure Protocol（漸進式揭露協議）**

### AI MUST NOT

- 將「Feature 要修改 X」視為錯誤（那是意圖）
- 修改任何檔案
- 在資料不足時猜測
- 對全新功能強制套用「複用檢查」（標記 N/A）

---

## Progressive Disclosure Protocol

### 最小載入清單

> **System 層定義**：`specs/system/` 整個資料夾，包含：
> - `spec.md`（System Spec：WHAT）
> - `data-model.md`、`flows.md`、`contracts/`、`ui/`（System Design：HOW）

| 來源 | 僅讀取 | 不讀取 |
|------|--------|--------|
| **Feature spec.md** | 變更聲明（新增/修改/刪除標記）、影響範圍 | 詳細 AC |
| **Feature plan.md** | 架構決策、模組選擇、Phase 規劃、檔案清單 | 完整實作細節 |
| **system-context.md** | 模組邊界、共享服務、Entry Points | 完整歷史 |
| **System Spec** (`spec.md`) | Section Headers、被 Plan 涉及的區段 | 未涉及區段 |
| **System Design** | 依 Plan 涉及類別選擇性讀取（見下表） | 未涉及的檔案 |
| **src/** | 目錄結構、檔案名稱 | 完整程式碼 |

**System Design 分層讀取規則**：

| Plan 涉及類別 | 讀取的 System Design 檔案 |
|---------------|---------------------------|
| 資料欄位變更 | `data-model.md` 的相關 Entity |
| API/Webhook 變更 | `contracts/*.md` 的相關定義 |
| 流程變更 | `flows.md` 的相關 Flow |
| UI 變更 | `ui/*.md` 的相關 Screen/Pattern |

### 分階段解析度

#### Stage 1：結構掃描

- 讀取 Plan 的架構決策和檔案清單
- 讀取 system-context.md 的模組邊界和共享服務
- 建立「Plan 涉及項目 ↔ 現有元素」對應表

#### Stage 2：針對性深讀

- 僅對 Stage 1 發現的潛在問題項目深讀
- 記錄至 Escalation Log

---

## 執行步驟

### Phase 0：前置條件檢查

**輸入**：$ARGUMENTS（Feature 名稱或路徑）

**執行**：

1. **確認 Feature 目錄存在**：
   - 必須包含：`spec.md`、`plan.md`
   - `tasks.md` 可以不存在（本工具在 tasks 前執行）

2. **確認參考資料存在**：
   - `.flowkit/memory/system-context.md`（建議但非必要）
   - `specs/system/` 目錄（System 層），包含：
     - `spec.md`（必要）
     - `data-model.md`（若 Plan 涉及資料）
     - `contracts/`（若 Plan 涉及 API/Webhook）
     - `flows.md`（若 Plan 涉及流程）
     - `ui/`（若 Plan 涉及 UI）
   - `src/` 目錄

3. **判斷 Feature 類型**：

   | 類型 | 判斷依據 | 影響 |
   |------|----------|------|
   | **全新功能** | Spec 無「修改」標記，純新增 | 跳過部分複用檢查 |
   | **修改功能** | Spec 有「修改」或「刪除」標記 | 完整檢查 |
   | **重構** | Spec 聲明為重構類型 | 強化架構檢查 |

**輸出**：Feature 類型、檢查範圍確認

---

### Phase 1：抽取 Plan 決策清單

**輸入**：`FEATURE_DIR/plan.md`

**執行**：

1. **抽取架構決策**：
   - 使用的技術/框架
   - 新增的模組/類別
   - 修改的現有模組

2. **抽取檔案清單**：
   - 新增檔案
   - 修改檔案
   - 涉及的目錄

3. **抽取依賴關係**：
   - 引用的外部套件
   - 使用的內部模組

**輸出**：Plan 決策清單

---

### Phase 2：比對現有系統（漸進式）

**輸入**：Plan 決策清單、system-context.md、System Spec、src/

**執行**：

#### 2.1 模組邊界檢查（Stage 1）

1. **掃描 system-context.md 的共享服務清單**
2. **比對 Plan 中的模組設計**：

   | 檢查項目 | 問題類型 |
   |----------|----------|
   | Plan 新增模組名稱與現有模組相似 | 潛在重複 |
   | Plan 未使用已存在的共享服務 | 遺漏複用 |
   | Plan 跨越了模組邊界 | 架構風險 |

#### 2.2 功能重複檢查（Stage 1 + Stage 2）

1. **掃描 src/ 目錄結構**：
   - 識別與 Plan 功能相似的現有檔案/模組

2. **若發現潛在重複，深讀確認**：
   - 讀取現有模組的 docstring 或 README
   - 判斷是否真的重複

#### 2.3 變更範圍檢查

1. **比對 Feature Spec 聲明的變更範圍**
2. **檢查 Plan 是否涉及未聲明的區域**：

   | 情況 | 判定 |
   |------|------|
   | Plan 修改的檔案在 Spec 變更範圍內 | ✅ 意圖內 |
   | Plan 修改的檔案不在 Spec 變更範圍 | ⚠️ 待確認 |

**輸出**：比對結果清單

---

### Phase 3：一致性檢查（檢測通道）

**輸入**：比對結果清單

**執行**：

#### A. 重複實作檢查

| ID | 檢查項目 | 說明 | 嚴重性 |
|----|----------|------|--------|
| A1 | 功能重複 | Plan 規劃的功能與現有功能高度相似 | HIGH |
| A2 | 模組重複 | Plan 新增的模組名稱與現有模組相似 | MEDIUM |
| A3 | 邏輯重複 | Plan 的處理流程與現有流程雷同 | MEDIUM |

**全新功能時**：標記 A1-A3 為「適用：部分」，僅檢查是否有可複用的基礎設施。

#### B. 複用遺漏檢查

| ID | 檢查項目 | 說明 | 嚴重性 |
|----|----------|------|--------|
| B1 | 共享服務未使用 | system-context.md 列出的共享服務未被 Plan 引用 | HIGH |
| B2 | 工具函數重寫 | Plan 設計了已存在的工具函數 | MEDIUM |
| B3 | 模式未遵循 | Plan 未遵循專案既有的設計模式 | MEDIUM |

**全新功能時**：B1 仍適用（應使用共享服務），B2-B3 視情況標記 N/A。

#### C. 非意圖變動檢查

| ID | 檢查項目 | 說明 | 嚴重性 |
|----|----------|------|--------|
| C1 | 範圍溢出 | Plan 涉及 Spec 未聲明的變更區域 | HIGH |
| C2 | 隱性依賴 | Plan 的修改會影響未列出的模組 | MEDIUM |
| C3 | 副作用風險 | Plan 的架構決策可能影響現有功能 | MEDIUM |

#### D. 細節誤用檢查

| ID | 檢查項目 | 說明 | 嚴重性 |
|----|----------|------|--------|
| D1 | ID 引用錯誤 | 引用的 UI ID / Entity ID 不存在 | HIGH |
| D2 | 命名不一致 | 與專案命名慣例不符 | MEDIUM |
| D3 | 路徑錯誤 | Plan 中的檔案路徑格式錯誤 | MEDIUM |
| D4 | 版本不符 | 引用的套件版本與專案不一致 | LOW |

#### E. 整合建議（非阻擋性）

| ID | 檢查項目 | 說明 | 類型 |
|----|----------|------|------|
| E1 | 更好的模組位置 | Plan 的新模組可放在更合適的位置 | SUGGESTION |
| E2 | 可抽象化機會 | Plan 的實作可抽象為共享服務 | SUGGESTION |
| E3 | 現有模式適用 | 可套用專案既有的設計模式 | SUGGESTION |

---

### Phase 4：產生分析報告

**輸入**：所有檢測結果

**執行**：

```markdown
## FlowKit Consistency Check 分析報告

### 基本資訊
- **Feature**：[NNN-feature-name]
- **Feature 類型**：[全新功能 / 修改功能 / 重構]
- **執行時間**：[timestamp]

### 檢查結果摘要

| 類別 | 確定問題 | 待確認 | N/A |
|------|----------|--------|-----|
| A. 重複實作 | N | N | N |
| B. 複用遺漏 | N | N | N |
| C. 非意圖變動 | N | N | N |
| D. 細節誤用 | N | N | N |
| E. 整合建議 | - | N | - |

### 確定問題（必須處理）

| ID | 類別 | 嚴重性 | 說明 | 建議修正 |
|----|------|--------|------|----------|
| ... | ... | ... | ... | ... |

### 待確認項目（需人工判斷）

| ID | 類別 | 說明 | 需確認的問題 |
|----|------|------|--------------|
| ... | ... | ... | 這是意圖內的變更嗎？ |

### 整合建議（非阻擋性）

| ID | 說明 | 效益 |
|----|------|------|
| E1 | ... | 提高可維護性 |

### Escalation Log
[深讀記錄]

### 下一步
- 若有「確定問題」→ 修正 Plan 後重新執行本檢查
- 若僅有「待確認」→ 人工確認後可繼續 `/speckit.tasks`
- 若全部通過 → 執行 `/speckit.tasks`
```

---

## 完成標準（Definition of Done）

```markdown
## Consistency Check DoD

### 必要條件
- [ ] 所有檢測通道已執行（A-E）
- [ ] 確定問題已列出具體修正建議
- [ ] 待確認項目已說明需確認的問題
- [ ] Escalation Log 已記錄

### 報告品質
- [ ] 每個發現都區分「確定問題」或「待確認」
- [ ] 全新功能的不適用項目已標記 N/A
- [ ] 整合建議與阻擋性問題明確區分
```

---

## 錯誤處理

| 錯誤情境 | 嚴重性 | 處理方式 |
|----------|--------|----------|
| plan.md 不存在 | CRITICAL | ERROR + 指示先執行 `/speckit.plan` |
| system-context.md 不存在 | MEDIUM | WARNING + 跳過共享服務檢查，建議建立 |
| System Spec 不存在 | HIGH | ERROR + 無法執行範圍檢查 |
| src/ 不存在 | MEDIUM | WARNING + 跳過程式碼重複檢查 |

---

## 快速參考

### 心智模型

```
Feature Spec (聲明的變更意圖)
       │
       ▼
Feature Plan (實現方式)
       │
       ├──────────────────────────────────────┐
       │                                      │
       ▼                                      ▼
┌─────────────────┐                  ┌─────────────────┐
│ 與意圖一致的設計 │                  │ 非意圖性錯誤     │
│ ✅ 不檢查        │                  │ ⚠️ 本工具檢查    │
└─────────────────┘                  └─────────────────┘
                                              │
                                     ┌────────┴────────┐
                                     │                 │
                              重複/遺漏複用      範圍溢出/細節錯誤
```

### 關鍵規則

1. **意圖優先**：Spec 聲明的變更不是錯誤
2. **非意圖檢查**：只檢查疏忽和錯誤
3. **條件適用**：全新功能跳過部分檢查
4. **建議 vs 阻擋**：整合建議不阻擋流程
5. **人工確認**：待確認項目需人工判斷

### 與其他指令的關係

```
/speckit.specify → /speckit.plan → /flowkit.consistency-check ◄ 本指令
                                            │
                                   ┌────────┴────────┐
                                   │                 │
                               有問題            全部通過
                                   │                 │
                                   ▼                 ▼
                             修正 Plan        /speckit.tasks
```

```

